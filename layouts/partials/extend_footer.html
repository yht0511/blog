<style>
    .post-content del {
        text-decoration: none; /* 移除删除线 */
        background-color: #ffecb3; /* 设置一个柔和的黄色高亮 */
        color: #333; /* 确保文本颜色可读 */
        padding: 1px 3px;
        border-radius: 3px;
    }
</style>

<button id="unlock-secrets-btn">管理员登录</button>

<div id="secret-modal">
    <div id="secret-modal-content">
        <h2>输入解密密钥</h2>
        <label for="github-token">GitHub API Token:</label>
        <input type="password" id="github-token" name="github-token">
        <label for="rsa-private-key">RSA Private Key:</label>
        <textarea id="rsa-private-key" name="rsa-private-key" rows="5"></textarea>
        <div id="secret-modal-buttons">
            <button id="close-modal-btn">关闭</button>
            <button id="save-keys-btn">保存并刷新</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/js-sha256@0.11.0/src/sha256.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const unlockBtn = document.getElementById('unlock-secrets-btn');
        const modal = document.getElementById('secret-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const saveKeysBtn = document.getElementById('save-keys-btn');

        unlockBtn.addEventListener('click', () => {
            modal.classList.add('show');
        });

        closeModalBtn.addEventListener('click', () => {
            modal.classList.remove('show');
        });

        saveKeysBtn.addEventListener('click', () => {
            const githubToken = document.getElementById('github-token').value;
            const privateKey = document.getElementById('rsa-private-key').value;

            if (githubToken && privateKey) {
                localStorage.setItem('githubToken', githubToken);
                localStorage.setItem('rsaPrivateKey', privateKey);
                alert('密钥已保存！');
                modal.classList.remove('show');
                location.reload(); // Reload to decrypt content
            } else {
                alert('请填写所有字段！');
            }
        });

        // Auto-run on page load
        (async function decryptContent() {
            const githubToken = localStorage.getItem('githubToken');
            const privateKey = localStorage.getItem('rsaPrivateKey');
            console.log("Retrieved keys from localStorage:", {
                githubToken: githubToken ? '***' : null,
                privateKey: privateKey ? '***' : null
            });
            
            // If keys are not present, make sure the login button is visible and stop.
            if (!githubToken || !privateKey) {
                unlockBtn.style.display = 'inline-block';
                return;
            }

            // If keys are present, hide the login button.
            unlockBtn.style.display = 'none';

            const placeholders = document.querySelectorAll('.secret-placeholder');
            // If there's no secret content on this page, do nothing.
            if (placeholders.length === 0) {
                return;
            }

            // If we have keys AND placeholders, create and show a status indicator.
            const statusIndicator = document.createElement('span');
            statusIndicator.id = 'secret-status';
            statusIndicator.textContent = '正在解密...';
            statusIndicator.style.marginLeft = '10px';
            statusIndicator.style.padding = '8px 16px';
            statusIndicator.style.borderRadius = 'var(--radius)';
            statusIndicator.style.background = 'var(--tertiary)';
            statusIndicator.style.color = 'var(--content)';
            
            // Insert the status indicator after the unlock button's original position
            unlockBtn.parentNode.insertBefore(statusIndicator, unlockBtn.nextSibling);

            let titleElement = document.querySelector('.post-title');
            if (!titleElement) {
                const content = document.querySelector('.post-content');
                if (content) {
                    titleElement = content.querySelector('h1');
                }
            }
            console.log("Located title element:", titleElement);

            if (!titleElement) {
                statusIndicator.textContent = '错误：找不到标题';
                statusIndicator.style.color = 'red';
                return;
            }
            const title = titleElement.textContent.trim();
            const titleHash = sha256(title);
            const secretFileName = `${titleHash}.json`;
            console.log("Computed title hash and secret file name:", { titleHash, secretFileName });

            const url = `https://api.github.com/repos/yht0511/blog-secret/contents/${secretFileName}`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3.raw'
                    }
                });

                if (!response.ok) {
                    throw new Error(`GitHub API request failed: ${response.statusText}`);
                }

                const payload = await response.json();

                const decrypt = new JSEncrypt();
                decrypt.setPrivateKey(privateKey);
                const sessionKeyRaw = decrypt.decrypt(payload.encrypted_session_key);
                if (!sessionKeyRaw) {
                    throw new Error("解密会话密钥失败。请检查你的RSA私钥。");
                }
                const sessionKey = CryptoJS.enc.Base64.parse(sessionKeyRaw);

                const iv = CryptoJS.enc.Base64.parse(payload.iv);
                const ciphertext = payload.ciphertext;
                
                const decrypted = CryptoJS.AES.decrypt(ciphertext, sessionKey, {
                    iv: iv,
                    mode: CryptoJS.mode.CBC,
                    padding: CryptoJS.pad.Pkcs7
                });

                const decryptedJson = decrypted.toString(CryptoJS.enc.Utf8);
                if (!decryptedJson) {
                    throw new Error("AES解密数据失败。");
                }
                
                const secretContentMap = JSON.parse(decryptedJson);

                placeholders.forEach(placeholder => {
                    const contentHash = placeholder.getAttribute('data-id');
                    if (secretContentMap[contentHash]) {
                        const secretMarkdown = secretContentMap[contentHash];
                        const secretHtml = marked.parseInline(secretMarkdown);
                        placeholder.outerHTML = secretHtml;
                    }
                });

                statusIndicator.textContent = '解密成功';
                statusIndicator.style.background = 'var(--code-bg)';
                statusIndicator.style.color = 'green';

            } catch (error) {
                console.error("解密或渲染过程中出错:", error);
                statusIndicator.textContent = '解密失败';
                statusIndicator.style.background = 'var(--code-bg)';
                statusIndicator.style.color = 'red';
                // Show the login button again if decryption fails, allowing user to re-enter keys
                unlockBtn.style.display = 'inline-block';
                unlockBtn.textContent = '解密失败，请重试';
            }
        })();
    });
</script>
