<style>
    .post-content del {
        text-decoration: none; /* 移除删除线 */
        background-color: #ffecb3; /* 设置一个柔和的黄色高亮 */
        color: #333; /* 确保文本颜色可读 */
        padding: 1px 3px;
        border-radius: 3px;
    }

    #admin-login-container {
        position: fixed;
        bottom: 15px;
        right: 15px;
        z-index: 1000;
    }

    #unlock-secrets-btn {
        background: none;
        border: none;
        color: var(--secondary);
        cursor: pointer;
        font-size: 12px;
        opacity: 0.6;
        transition: opacity 0.2s ease-in-out;
    }

    #unlock-secrets-btn:hover {
        opacity: 1;
    }
</style>

<div id="admin-login-container">
    <button id="unlock-secrets-btn">管理员登录</button>
</div>

<div id="secret-modal">
    <div id="secret-modal-content">
        <h2>输入解密密钥</h2>
        <label for="github-token">GitHub API Token:</label>
        <input type="password" id="github-token" name="github-token">
        <label for="rsa-private-key">RSA Private Key:</label>
        <textarea id="rsa-private-key" name="rsa-private-key" rows="5"></textarea>
        <div id="secret-modal-buttons">
            <button id="close-modal-btn">关闭</button>
            <button id="save-keys-btn">保存并刷新</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/js-sha256@0.11.0/src/sha256.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    document.get_encrypted_json = async function (filename) {
        const githubToken = localStorage.getItem('githubToken');
        if (!githubToken) {
            throw new Error("GitHub Token not found in localStorage.");
        }

        const url = `https://api.github.com/repos/yht0511/blog-secret/contents/${filename}`;
        const response = await fetch(url, {
            headers: {
                'Authorization': `token ${githubToken}`,
                'Accept': 'application/vnd.github.v3.raw'
            }
        });

        if (!response.ok) {
            throw new Error(`GitHub API request failed: ${response.statusText}`);
        }

        return await response.json();
    };
    document.get_all_placeholders = function () {
        return document.querySelectorAll('.secret-placeholder');
    };
    document.get_all_title_hashes = function () {
        const placeholders = document.querySelectorAll('.secret-placeholder');
        const titleHashes = new Set();
        placeholders.forEach(placeholder => {
            const titleHash = placeholder.getAttribute('title-hash');
            if (titleHash) {
                titleHashes.add(titleHash);
            }
        });
        return Array.from(titleHashes);
    };
    document.get

    document.addEventListener('DOMContentLoaded', function () {
        const unlockBtn = document.getElementById('unlock-secrets-btn');
        const modal = document.getElementById('secret-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const saveKeysBtn = document.getElementById('save-keys-btn');

        unlockBtn.addEventListener('click', () => {
            modal.classList.add('show');
        });

        closeModalBtn.addEventListener('click', () => {
            modal.classList.remove('show');
        });

        saveKeysBtn.addEventListener('click', () => {
            const githubToken = document.getElementById('github-token').value;
            const privateKey = document.getElementById('rsa-private-key').value;

            if (githubToken && privateKey) {
                localStorage.setItem('githubToken', githubToken);
                localStorage.setItem('rsaPrivateKey', privateKey);
                alert('密钥已保存！');
                modal.classList.remove('show');
                location.reload(); // Reload to decrypt content
            } else {
                alert('请填写所有字段！');
            }
        });

        // Auto-run on page load
        (async function decryptContent() {
            const githubToken = localStorage.getItem('githubToken');
            const privateKey = localStorage.getItem('rsaPrivateKey');
            console.log("Retrieved keys from localStorage:", {
                githubToken: githubToken ? '***' : null,
                privateKey: privateKey ? '***' : null
            });

            if (!githubToken || !privateKey) {
                unlockBtn.style.display = 'inline-block';
                return;
            }

            unlockBtn.style.display = 'none';

            // if (!window.location.pathname.startsWith('/post/') && !window.location.pathname.startsWith('/thought/')) {
            //     return;
            // }

            const placeholders = document.querySelectorAll('.secret-placeholder');
            if (placeholders.length === 0) {
                return;
            }

            const statusIndicator = document.createElement('span');
            statusIndicator.id = 'secret-status';
            statusIndicator.textContent = '正在解密...';
            statusIndicator.style.marginLeft = '10px';
            statusIndicator.style.padding = '8px 16px';
            statusIndicator.style.borderRadius = 'var(--radius)';
            statusIndicator.style.background = 'var(--tertiary)';
            statusIndicator.style.color = 'var(--content)';
            unlockBtn.parentNode.insertBefore(statusIndicator, unlockBtn.nextSibling);

            const placeholdersByHash = new Map();
            let pageTitleHash = null;

            for (const placeholder of placeholders) {
                let hash = placeholder.getAttribute('title-hash');
                if (!hash) {
                    if (pageTitleHash === null) {
                        let titleElement = document.querySelector('.post-title');
                        if (!titleElement) {
                            const content = document.querySelector('.post-content');
                            if (content) {
                                titleElement = content.querySelector('h1');
                            }
                        }
                        let title;
                        if (titleElement) {
                            title = titleElement.textContent.trim();
                        } else {
                            let ogTitle = document.querySelector('meta[property="og:title"]');
                            title = ogTitle ? ogTitle.getAttribute('content') : null;
                        }

                        if (!title) {
                            statusIndicator.textContent = '错误：找不到标题';
                            statusIndicator.style.color = 'red';
                            return;
                        }
                        pageTitleHash = sha256(title);
                    }
                    hash = pageTitleHash;
                }

                if (!placeholdersByHash.has(hash)) {
                    placeholdersByHash.set(hash, []);
                }
                placeholdersByHash.get(hash).push(placeholder);
            }

            let allSucceeded = true;

            for (const [titleHash, groupedPlaceholders] of placeholdersByHash.entries()) {
                const secretFileName = `${titleHash}.json`;
                console.log("Processing hash and secret file name:", { titleHash, secretFileName });
                const url = `https://api.github.com/repos/yht0511/blog-secret/contents/${secretFileName}`;

                try {
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3.raw'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`GitHub API request failed for ${secretFileName}: ${response.statusText}`);
                    }

                    const payload = await response.json();
                    const decrypt = new JSEncrypt();
                    decrypt.setPrivateKey(privateKey);
                    const sessionKeyRaw = decrypt.decrypt(payload.encrypted_session_key);
                    if (!sessionKeyRaw) {
                        throw new Error("解密会话密钥失败。请检查你的RSA私钥。");
                    }
                    const sessionKey = CryptoJS.enc.Base64.parse(sessionKeyRaw);
                    const iv = CryptoJS.enc.Base64.parse(payload.iv);
                    const ciphertext = payload.ciphertext;
                    const decrypted = CryptoJS.AES.decrypt(ciphertext, sessionKey, {
                        iv: iv,
                        mode: CryptoJS.mode.CBC,
                        padding: CryptoJS.pad.Pkcs7
                    });
                    const decryptedJson = decrypted.toString(CryptoJS.enc.Utf8);
                    if (!decryptedJson) {
                        throw new Error("AES解密数据失败。");
                    }
                    const secretContentMap = JSON.parse(decryptedJson);

                    groupedPlaceholders.forEach(placeholder => {
                        const contentHash = placeholder.getAttribute('data-id');
                        if (secretContentMap[contentHash]) {
                            const secretMarkdown = secretContentMap[contentHash];
                            const secretHtml = marked.parseInline(secretMarkdown);
                            placeholder.outerHTML = secretHtml;
                        }
                    });
                } catch (error) {
                    console.error(`解密或渲染过程中出错 (file: ${secretFileName}):`, error);
                    allSucceeded = false;
                }
            }

            if (allSucceeded) {
                statusIndicator.textContent = '解密成功';
                statusIndicator.style.background = 'var(--code-bg)';
                statusIndicator.style.color = 'green';
            } else {
                statusIndicator.textContent = '部分内容解密失败';
                statusIndicator.style.background = 'var(--code-bg)';
                statusIndicator.style.color = 'red';
                unlockBtn.style.display = 'inline-block';
                unlockBtn.textContent = '解密失败，请重试';
            }
        })();
    });
</script>
